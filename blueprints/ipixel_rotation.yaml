blueprint:
  name: iPixel – Rotierende Mehrfachanzeige (mit Farbverlauf)
  description: >
    Zeigt mehrere Sensorwerte nacheinander auf einem iPixel Display an.
    Jede Anzeige besteht aus:
    - Einer Sensor-Entität (z. B. PV, SoC, Temperatur …)
    - Einem Textformat (z. B. "PV {{ value }}W")
    - Einem unteren & oberen Wert (Bereich, zwischen dem die Farbe verläuft)
    - Einer unteren & oberen RGB-Farbe (Color Selector)
    Zwischen niedriger und hoher Farbe wird automatisch interpoliert.
    Der Wechsel erfolgt nach einstellbarem Intervall (2–180 Sekunden).
    Der Whitespace-Trick verhindert sichtbare Farbwechsel vor dem Textwechsel.

    Unter „Anzuzeigende Einträge“ kannst du eine Liste anlegen:
    Beispiel:
      - entity: sensor.meine_entitaet1
        text: "PV {{ value }}W"
        low_value: 500
        high_value: 2500
        low_color: [255, 0, 0]
        high_color: [0, 255, 0]

    Die Reihenfolge der Einträge entspricht der späteren Anzeige-Reihenfolge.
    Das Display switcht also von Eintrag 1 → 2 → 3 … und wieder zurück zu 1.

  domain: automation

  input:
    display_entity:
      name: Display Text-Entity
      description: Text-Entity des iPixel Displays (z. B. text.display)
      selector:
        entity:
          domain: text

    color_entity:
      name: Farb-Entity (light)
      description: Light-Entity, die die Textfarbe steuert (z. B. light.text_color)
      selector:
        entity:
          domain: light

    rotation_interval:
      name: Wechselintervall (Sekunden)
      description: Wie schnell soll zwischen den Anzeigen gewechselt werden?
      default: 5
      selector:
        number:
          min: 2
          max: 180
          mode: slider
          unit_of_measurement: Sekunden

    entries:
      name: Anzuzeigende Einträge
      description: >
        Liste der Anzeigen, die nacheinander dargestellt werden.
        Jeder Eintrag definiert:
        - entity: Sensor-Entität
        - text: Format des anzuzeigenden Textes ({{ value }} wird ersetzt)
        - low_value: Unterer Wert (Beginn Farbverlauf)
        - high_value: Oberer Wert (Ende Farbverlauf)
        - low_color: RGB-Farbe unten
        - high_color: RGB-Farbe oben
      default:
        - entity: sensor.meine_entitaet1
          text: "Entität 1: {{ value }}"
          low_value: 0
          high_value: 100
          low_color: [255, 0, 0]
          high_color: [0, 255, 0]

        - entity: sensor.meine_entitaet2
          text: "Entität 2: {{ value }}"
          low_value: 10
          high_value: 80
          low_color: [255, 0, 0]
          high_color: [0, 255, 0]

        - entity: sensor.meine_entitaet3
          text: "Entität 3: {{ value }}"
          low_value: 500
          high_value: 2500
          low_color: [255, 0, 0]
          high_color: [0, 255, 0]
      selector:
        object:

mode: single

variables:
  display: !input display_entity
  color_light: !input color_entity
  interval: !input rotation_interval
  entries: !input entries

  # Rotation merken
  last_index: >
    {% set last = this.attributes.get('last_index', -1) %}
    {{ last | int }}

  next_index: >
    {% set count = entries | count %}
    {% if count == 0 %}
      0
    {% else %}
      {{ (last_index + 1) % count }}
    {% endif %}

  current_entry: >
    {{ entries[next_index] }}

  entity_id: >
    {{ current_entry.entity }}

  raw_value: >
    {{ states(entity_id) }}

  numeric_value: >
    {{ raw_value | float(0) }}

  # Text
  formatted_text: >
    {{ current_entry.text | replace("{{ value }}", numeric_value | round(0) | string ) }}

  # Bereich & Farben
  low_value: "{{ current_entry.low_value | float }}"
  high_value: "{{ current_entry.high_value | float }}"

  low_color: "{{ current_entry.low_color }}"
  high_color: "{{ current_entry.high_color }}"

  # Verhältnis 0–1
  ratio: >
    {% if numeric_value <= low_value %}
      0
    {% elif numeric_value >= high_value %}
      1
    {% else %}
      {{ (numeric_value - low_value) / (high_value - low_value) }}
    {% endif %}

  # Interpolierte RGB-Farbe
  r: >
    {{ (low_color[0] + (high_color[0] - low_color[0]) * ratio) | int }}
  g: >
    {{ (low_color[1] + (high_color[1] - low_color[1]) * ratio) | int }}
  b: >
    {{ (low_color[2] + (high_color[2] - low_color[2]) * ratio) | int }}

trigger:
  - platform: time_pattern
    seconds: "/{{ interval }}"

action:
  # neuen Index speichern
  - service: automation.modify
    data:
      entity_id: "{{ this.entity_id }}"
      variables:
        last_index: "{{ next_index }}"

  # Whitespace (nur beim Wechsel)
  - service: text.set_value
    target:
      entity_id: "{{ display }}"
    data:
      value: " "

  # Farbe anwenden
  - service: light.turn_on
    target:
      entity_id: "{{ color_light }}"
    data:
      rgb_color: ["{{ r }}","{{ g }}","{{ b }}"]

  # Text setzen
  - service: text.set_value
    target:
      entity_id: "{{ display }}"
    data:
      value: "{{ formatted_text }}"
